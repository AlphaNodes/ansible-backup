- name: Set date stamp
  set_fact: date_stamp="{{ lookup('pipe','date +%Y%m%d%H%M') }}"
  tags: vars

- name: Set day stamp
  set_fact: day_stamp="{{ lookup('pipe','date +%Y%m%d') }}"
  tags: vars

- name: Ensures backup_dir exists
  file:
    path: '{{ backup_dir }}'
    state: directory
    mode: '{{ backup_dir_mode }}'
    owner: '{{ backup_dir_owner }}'
    group: '{{ backup_dir_group }}'

- name: Run backup pre commands
  command: "{{ item }}"
  loop: '{{ backup_pre_commands | default([]) }}'

- name: Include clear tasks
  include_tasks: clear.yml
  tags: clear

- name: Include MySQL tasks
  include_tasks: db_mysql.yml
  tags: mysql
  when: backup_with_mysql

- name: Include PostgreSQL tasks
  include_tasks: db_postgresql.yml
  tags: postgresql
  when: backup_with_postgresql

- name: Include files tasks
  include_tasks: files.yml
  tags: files
  loop: "{{ backup_sets | default([]) }}"
  loop_control:
    loop_var: instance

- name: Include rsync tasks
  include_tasks: rsync.yml
  tags: sync
  when: backup_remote_host != '' and backup_remote_transfer == 'rsync'

- name: Include lftp tasks
  include_tasks: lftp.yml
  tags: sync
  when: backup_remote_host != '' and backup_remote_transfer == 'lftp'

- name: Run backup post commands
  command: "{{ item }}"
  loop: '{{ backup_post_commands | default([]) }}'
